name: image creator CI

on: [pull_request]

jobs:
  build:
    name: Create a machine image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'
          create_credentials_file: true
          export_environment_variables: true

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Use gcloud CLI'
        run: 'gcloud info'

      - name: 'create instance template'
        run: |
          gcloud compute instance-templates create csye6225-vm3 \
          --machine-type=e2-medium \
          --tags=webapp \
          --region=us-east1 \
          --instance-template-region=us-east1 \
          --image=csye6225-2024-04-03-14-05-03 \
          --boot-disk-size=100GB \
          --boot-disk-type=pd-balanced \
          --network-interface="network=cloud-vpc,subnet=webapp,network-tier=PREMIUM" \
          --service-account=webapp-service-account@cloud-assigment-4.iam.gserviceaccount.com \
          --scopes=https://www.googleapis.com/auth/cloud-platform \
          --metadata=startup-script=$'#!/bin/bash\n# Check if SQL_URI key exists in the .env file\nif grep -q "^SQL_URI=" "/home/csye6225/webapp/.env"; then\n    echo "SQL_URI key already exists in the .env file."\nelse\n    echo "Adding SQL_URI to the .env file."\n    echo "SQL_URI=mysql://webapp:hcK446dmHNmdQuNM@10.12.0.4:3306/" | sudo tee -a "/home/csye6225/webapp/.env" > /dev/null\n    echo "DATABASE=webapp" | sudo tee -a "/home/csye6225/webapp/.env" > /dev/null\n    # Only create the .env_ready file if SQL_URI is added\n    touch "/tmp/.env_ready"\n    echo ".env_ready file created in /tmp."\nfi'